#!/bin/bash
# Log forwarding script - Generated by Ansible
# Forwards test results and validation logs to ELK stack

TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
ELASTICSEARCH_URL="http://localhost:{{ elasticsearch_port }}"
LOG_DIR="/var/log"

# Function to send log entry to Elasticsearch
send_to_elk() {
    local index="$1"
    local logtype="$2" 
    local message="$3"
    local host="${4:-$(hostname)}"
    
    curl -s -X POST "${ELASTICSEARCH_URL}/${index}/_doc" \
        -H "Content-Type: application/json" \
        -d '{
            "@timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'",
            "host": "'${host}'",
            "service": "'${logtype}'",
            "logtype": "'${logtype}'",
            "environment": "{{ environment_type | default('development') }}",
            "message": "'${message}'"
        }' >/dev/null
}

# Forward test results if they exist
if [ -f "${LOG_DIR}/test-results.log" ]; then
    while IFS= read -r line; do
        if [ ! -z "$line" ]; then
            send_to_elk "logs-testing-$(date +%Y.%m.%d)" "testing" "$line"
        fi
    done < "${LOG_DIR}/test-results.log"
    # Clear the processed file
    > "${LOG_DIR}/test-results.log"
fi

# Forward Molecule test results
for molecule_log in "${LOG_DIR}"/molecule*.log; do
    if [ -f "$molecule_log" ]; then
        while IFS= read -r line; do
            if [ ! -z "$line" ]; then
                send_to_elk "logs-molecule-$(date +%Y.%m.%d)" "molecule" "$line"
            fi
        done < "$molecule_log"
    fi
done

# Forward system monitoring logs
if [ -f "${LOG_DIR}/system-monitor.log" ]; then
    tail -n 100 "${LOG_DIR}/system-monitor.log" | while IFS= read -r line; do
        if [ ! -z "$line" ]; then
            send_to_elk "logs-monitoring-$(date +%Y.%m.%d)" "monitoring" "$line"
        fi
    done
fi

# Log the forwarding activity
echo "[$TIMESTAMP] Log forwarding completed" >> "${LOG_DIR}/log-forwarder.log"