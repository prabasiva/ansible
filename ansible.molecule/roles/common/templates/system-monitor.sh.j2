#!/bin/bash
# System monitoring script - Generated by Ansible

TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
HOSTNAME=$(hostname)

echo "[$TIMESTAMP] $HOSTNAME - System Status Report"

# CPU Usage
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}')
echo "CPU Usage: ${CPU_USAGE}%"

# Memory Usage
MEMORY_INFO=$(free -m | awk 'NR==2{printf "Memory Usage: %s/%sMB (%.2f%%)", $3,$2,$3*100/$2 }')
echo "$MEMORY_INFO"

# Disk Usage
DISK_USAGE=$(df -h | awk '$NF=="/"{printf "Disk Usage: %d/%dGB (%s)", $3,$2,$5}')
echo "$DISK_USAGE"

# Load Average
LOAD_AVG=$(uptime | awk -F'load average:' '{ print $2 }')
echo "Load Average:$LOAD_AVG"

# Network Connections
CONNECTIONS=$(netstat -an | wc -l)
echo "Network Connections: $CONNECTIONS"

# Check critical services
SERVICES=("ssh" "rsyslog" "cron")
for service in "${SERVICES[@]}"; do
    if systemctl is-active --quiet "$service"; then
        echo "Service $service: RUNNING"
    else
        echo "Service $service: STOPPED"
    fi
done

# Check if HAProxy is installed and running
if command -v haproxy &> /dev/null; then
    if systemctl is-active --quiet haproxy; then
        echo "Service haproxy: RUNNING"
    else
        echo "Service haproxy: STOPPED"
    fi
fi

# Check if Envoy is installed and running
if command -v envoy &> /dev/null; then
    if systemctl is-active --quiet envoy; then
        echo "Service envoy: RUNNING"
    else
        echo "Service envoy: STOPPED"
    fi
fi

# Check if Filebeat is installed and running
if command -v filebeat &> /dev/null; then
    if systemctl is-active --quiet filebeat; then
        echo "Service filebeat: RUNNING"
    else
        echo "Service filebeat: STOPPED"
    fi
fi

echo "---"